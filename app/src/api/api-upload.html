<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./ls-login.html">
<link rel="import" href="./api-behavior.html">

<dom-module id="api-upload">
  <template>
  
    <ls-login user-id="{{uid}}"></ls-login>

    <iron-ajax id="xhr"
      url="[[url]]"
      method="POST"
      handle-as="json"
      body="[[_body]]"
      loading="{{loading}}"
      last-error="{{_ajaxError}}"
      last-response="{{_results}}"></iron-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'api-upload',
        behaviors: [
          HiveOSS.ApiBehavior
        ],
        properties: {
          uid: String,
          /*
           * csv or excel `File` to upload.
           */
          file: Object,
          /*
           * Project name for the file.
           */
          projectName: String,
          /*
           * Automatically process and analyze the file.
           */
          analyze: {
            type: Boolean,
            value: false
          },
          /*
           * Automatically filter out non-useful lines in email text.
           */
          email: {
            type: Boolean,
            value: false
          },
          url: {
            type: String,
            value: 'api/project'
          },
          valid: {
            type: Boolean,
            notify: true,
            computed: '_isValid(_body)'
          },
          // _params: {
          //   type: Object,
          //   computed: '_computeParams(uid)'
          // },
          _body: {
            type: Object,
            computed: '_computeBody(projectName,file,uid)'
          }
        },

        _isValid: function(body) {
          return body && true;
        },

        // _computeParams: function(uid) {
        //   var ret = Object.create(null);
        //   ret.uid = uid;
        //   return ret;
        // },

        _computeBody: function(projectName, file, uid) {
          if (!projectName || !file || !uid)
            return;
          // ensure projectName is valid
          var formData = new FormData();
          formData.append('uid', uid);
          formData.append('prj', projectName);
          formData.append('file', file);
          return formData;
        }
      });
    })();
  </script>
</dom-module>
