<script>
  (function(HiveOSS) {
    'use strict';

    /** @polymerBehavior HiveOSS.ApiBehavior */
    HiveOSS.ApiBehavior = {
      properties: {
        /*
         * URL to the API
         */
        url: String,
        /*
         * Automatically call API when inputs are valid.
         */
        auto: Boolean,
        /*
         * Inputs are valid. Ready for ajax call.
         */
        valid: {
          type: Boolean,
          notify: true,
          readonly: true
        },
        /*
         * Array of error string returned by API. Empty Array if no errors.
         */
        errors: {
          type: Array,
          notify: true,
          readonly: true
        },
        /*
         * API return success (if no errors are sent)
         */
        success: {
          type: Boolean,
          notify: true,
          computed: '_success(_results,_ajaxError)'
        },
        /*
         * Ajax call in progress.
         */
        loading: {
          type: Boolean,
          notify: true
        },
        /*
         * `progress` object (if any) returned from iron-request object.
         */
        progress: {
          type: Object,
          notify: true,
          computed: '_get(_ironRequest.progress)'
        },
        canceled: {
          type: Boolean,
          notify: true,
          computed: '_get(_ironRequest.aborted)'
        },
        debounceDuration: {
          type: Number,
          value: 500
        },
        _errors: {
          type: Array,
          notify: true,
          computed: '_get(_results.error)'
        },
        _ironRequest: Object,
        _ajaxError: Object,
        _params: {
          type: Object,
          value: null
        },
        _body: {
          type: Object,
          value: null
        },
        _results: Object
      },

      observers: [
        '_auto(auto,url,_params,_body,valid)',
        '_fireError(_errors)',
        '_fireError(_ajaxError.statusText,_ajaxError.status)'
      ],

      _fireError: function(errors, status) {
        if (!errors || errors.length === 0) return;
        this.errors = Array.isArray(errors) ? errors : [errors];
        this.fire('error-message', {
          element: this,
          errors: this.errors,
          status: status || 200},
          {bubbles: true});
      },

      _auto: function(auto, url, params, body, valid) {
        if (!url) return;
        if (auto)
          this.generateRequest();
      },
      _sortNumber: function(arr) {
        if (!arr) return;
        return arr.map(function(n) {
          return parseInt(n, 10);
        }).sort();
      },
      _get: function(val) {
        return val;
      },
      _success: function(results, _ajaxError) {
        if (_ajaxError) return false;
        if (!results) return false;
        var success = !results.error || results.error.length === 0;
        if (success) this.fire('success', results);
        return success;
      },
      _generateRequest: function() {
        this.errors = null;
        this._ajaxError = null;
        this._ironRequest = this.$.xhr.generateRequest();
        this.fire('request', this._ironRequest);
        return this._ironRequest;
      },
      generateRequest: function() {
        if (!this.valid) return;
        var self = this;
        this.debounce('debounce', function() {
          self._generateRequest();
        }, self.debounceDuration);
      },

      cancelRequest: function() {
        this._ironRequest.abort();
      }
    };
  })(HiveOSS = window.HiveOSS || {});
</script>
