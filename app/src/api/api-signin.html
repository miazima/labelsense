<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../behaviors/route-behavior.html">

<link rel="import" href="./api-behavior.html">

<dom-module id="api-signin">
  <template>

    <firebase-auth
      id="auth" 
      user="{{user}}" 
      signed-in="{{signedIn}}"
      provider="google">
    </firebase-auth>


    <iron-ajax id="xhr"
      url="[[url]]"
      method="POST"
      content-type="application/json"
      handle-as="json"
      body="[[_body]]"
      params="[[_params]]"
      loading="{{loading}}"
      last-error="{{_ajaxError}}"
      last-response="{{_results}}"></iron-ajax>

      <iron-ajax id="xhr2"
      url="[[url]]"
      method="GET"
      content-type="application/json"
      handle-as="json"
      params="[[_params]]"
      loading="{{loading}}"
      last-error="{{_ajaxError}}"
      last-response="{{_results2}}"></iron-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'api-signin',
        behaviors: [
          HiveOSS.ApiBehavior,
          HiveOSS.RouteBehavior
        ],
        properties: {
          /*
           * Returns an Array<Object> representing the default project belonging to the user.
           */
          defaultProject: {
            type: Array,
            notify: true,
            readonly: true,
            computed: '_getDefaultProject(_results2)'
          },
          /*
           * Email of the account.
           */
          email: {
            type: String,
            computed: '_get(user.email)'
          },
          /*
           * uid of the account.
           */
          uid: {
            type: String,
            computed: '_get(user.uid)',
            notify: true
          },
          admin: Boolean,
          signout: {
            type: Boolean,
            value: false
          },
          url: {
            type: String,
            value: 'api/users'
          },
          valid: {
            type: Boolean,
            notify: true,
            computed: '_isValid(_params, _body)'
          },
          _body: {
            type: Object,
            computed: '_computeBody(email,uid,admin)'
          },
          _params: {
            type: Object,
            computed: '_computeParams(uid)'
          },
          user: {
            type: Object,
            notify: true,
            observer: 'userDetails'
          },
          signedIn: {
            type: Boolean
          }
        },

        observers: [
          'isAuthenticated(signedIn,uid,email,admin)'
        ],

        signIn: function() {
          this.$.auth.signInWithPopup();
        },

        signOut: function() {
          this.routeToLandingPage();
          this.$.auth.signOut();
        },

        userDetails: function(details) {
          if (details) {
            this.routeToAppPage();
          }
        },

        isAuthenticated:function(auth, uid, email, admin) {
          if (!uid || !email || !admin) return;
          if (auth) {
            this.generateRequest();
            this.routeToAppPage();
          }
        },

        _isValid: function(params, body) {
          return (params || body) && true;
        },

        _computeBody: function(email, uid, admin) {
          if (!email || !uid || !admin)
            return;

          return {
            email: email,
            uid: uid,
            admin: admin
          };
        },

        _computeParams: function(uid) {
          var params = Object.create(null);
          params.uid = uid;
          return params;
        },

        getUser: function() {
          this.$.xhr2.generateRequest();
        },

        _getDefaultProject: function(res) {
          if (res.users.length === 0 || !res.users[0].prj) return null;
          return res.users[0].prj;
        }
      });
    })();
  </script>
</dom-module>
