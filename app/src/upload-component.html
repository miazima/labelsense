<link rel="import" href="../bower_components/hiveoss-dragdrop-box/hiveoss-dragdrop-box.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./validator-projectname.html">
<link rel="import" href="theme/shared-styles.html">
<link rel="import" href="api/api-project.html">

<dom-module id="upload-component">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}
	    hiveoss-dragdrop-box /deep/ #placeholder{
        display: none !important;
      }
	    hiveoss-dragdrop-box#dragdrop {
	    	@apply(--layout-flex-auto);
        background: 50% 50% no-repeat url(assets/upload-over.png);
        background-size: 25vh;
        height: 25vh;
	    }
	    paper-button.uploadBtn {
				padding: 12px 18px;
				width: 35%;
				background: var(--paper-indigo-500);
				cursor: pointer;
				color: white;
			}
			.paper-textfield { width: 35%; }
		</style>

		<api-project id="project" uid="[[uid]]" project-name="[[projectName]]" file="[[projectFile]]" on-success="_handleSuccess"></api-project>
		
		<div class="main-content-wrapper layout vertical">			
			<div class="content-wrapper layout vertical self-center">
				<hiveoss-dragdrop-box id="dragdrop"
		     form-data="{{formData}}"
		     last-file="{{projectFile}}"
		     on-form-data="_handleFileAdded">
		    </hiveoss-dragdrop-box>
		    <!--Uploaded file name -->
	      <p id="selectedFile" class="self-center">
	        <span class="upload-file-placeholder" hidden$="[[!noFileSelected]]">[[description]]</span>
	        <span class="selected-file-info" hidden$="[[noFileSelected]]">[[projectFile.name]] | [[projectFile.size]] bytes</span>
	      </p>
			</div>

      <div class="content-wrapper horizontal center-justified layout self-center">
    		<validator-projectname project-list=[[projectList]]></validator-projectname>
	      <paper-input-container class="paper-textfield" auto-validate invalid="[[_invalidProjectName]]">
	        <label>Analysis Name</label>
	        <iron-a11y-keys id="a11y"
	          target="[[targetProjectNameInput]]"
	          keys="enter"
	          on-keys-pressed="execute"></iron-a11y-keys>
	        <input id="projNameTextBox" is="iron-input" bind-value="{{projectName}}"
	                required
	                auto-validate
	                prevent-invalid-input
	                invalid="{{_invalidProjectName}}"
	                allowed-pattern="[a-zA-z0-9_]"
	                autofocus="true"
	                validator="validator-projectname"></input>
	        <paper-input-error>Project name has already been used or empty</paper-input-error>
	      </paper-input-container>
    	</div>

    	<div class="content-wrapper horizontal center-justified layout self-center">
    		<paper-button class="uploadBtn paper-font-button" raised on-tap="executeUpload" disabled=[[invalidInput]]>Upload New Project
				<iron-icon class="end-justified" icon="file-upload"></paper-button>
    	</div>
		</div>

	</template>
	<script>
		Polymer({
			is: 'upload-component',
			properties: {
				uid: String,
				formData: Object,
				projectFile: Object,
				projectName: String,
				_invalidProjectName: Boolean,
				targetProjectNameInput: {
          type: Object,
          value: function() {
            return this.$.projNameTextBox;
          }
        },
        noFileSelected: {
        	type: Boolean,
        	value: true
        },
        invalidInput: {
          type: Boolean,
          value: true,
          computed: '_invalidInput(noFileSelected,projectName,_invalidProjectName)'
        },
        projectList: {
          type: Array,
          value: []
        }
			},

			_handleFileAdded: function() {
        this.noFileSelected = false;
        this.$.projNameTextBox.focus();
      },

      _handleSuccess: function() {
      	this.fire('display-list');
      },

      _invalidInput: function(noFileSelected, projectName,_invalidProjectName) {
        return noFileSelected || _invalidProjectName ||
          (!projectName || projectName.length === 0);
      },

			executeUpload: function() {
				if (this.invalidInput) return;
				this.$.project.uploadProject();
			},

			_visibleChanged: function() {
        if (this.visible) {
          this.projectName = '';
          this.projectFile = null;
          this.formData = null;
          this.noFileSelected = true;
          this._invalidProjectName = false;
        }
      }
		});
	</script>
</dom-module>