<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="api/api-label.html">
<link rel="import" href="theme/shared-styles.html">

<dom-module id="label-page">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}
			paper-button[toggles][active] {
			  background: var(--paper-indigo-500);
			}
			paper-listbox.labelbox {
        padding: 0;
      }
      paper-listbox.labelbox > paper-item {
	      --paper-item: {
	        background: var(--paper-indigo-300);
	        color: white;
	        position: relative;
	      }
	      --paper-item-selected: { background: var(--paper-indigo-500); }
	      --paper-item-focused-before: { opacity: 0; }
      }
			.card-actions {
				padding: 10px 16px;
			}
			paper-fab { --paper-fab-background: var(--paper-teal-a700); }
			.teal-accent-btn { 
				padding-left: 30px; 
				padding-right: 30px; 
			}
			.main-wrapper { padding-bottom: 3em; }
			div.token {
				margin: 30px;
			}
			div.nav { 
				width: 50px;
				position: relative;
				/*height: calc(100vh - 64px - 3em);*/
			}
			div.navfix { position: fixed; }
			paper-fab.nav {
				position: absolute;
				top: 50%;
				left: calc(50% - 28px);
			}
			div.content-wrapper { overflow: hidden; }
		</style>

		<api-label id="label" uid=[[uid]] prj=[[prj]] labelData="[[labelData]]"></api-label>

		<app-localstorage-document key="prj" data="[[prj]]"></app-localstorage-document>

		<div class="main-content-wrapper layout vertical">

			<div class="content-wrapper paper-font-title self-center">[[prj]]</div>

			<div class="layout horizontal">

				<div class="nav flex">
					<paper-fab class="nav" icon="arrow-back" disabled="[[_disableNav(splitTokens,selectedPage,'prev')]]" on-tap="prevPage"></paper-fab>
				</div>

				<div class="content-wrapper">
					<iron-pages selected="{{selectedPage}}">
						<template id="firstRepeat" is="dom-repeat" items={{splitTokens}}>
							<div class$="content_[[index]]">
								<template class$="secondRepeat_[[index]]" is="dom-repeat" items={{item}} index-as="list">
									<div class="token layout horizontal">
										<paper-card class="flex-6">
										  <div class="card-content">[[item]]</div>
										</paper-card>
									 	<paper-listbox multi=[[multiSelect]] class$="labelbox flex-1 list_[[_computeListIndex(index,list)]]" attr-for-selected="value">
									 		<template is="dom-repeat" items={{labels}}>
									 			<!-- <paper-item>[[item]]</paper-item> -->
										 		<paper-item value$="[[item]]" raised class="paper-font-button layout horizontal center-justified">
											 		[[item]]<paper-ripple></paper-ripple>
										 		</paper-item>
									    </template>
									 	</paper-listbox>
									</div>
								</template>
							</div>
						</template>
					</iron-pages>
				</div>

				<!-- <div class="layout horizontal justified self-stretch"> -->
					
				<div class="nav flex">
					<paper-fab class="nav" icon="arrow-forward" disabled="[[_disableNav(splitTokens,selectedPage,'next')]]" on-tap="nextPage"></paper-fab>
				</div>
				<!-- </div> -->
			</div>

			<div class="layout vertical" hidden$="[[_displaySave(splitTokens,selectedPage)]]">
				<div class="self-center"><paper-button class="teal-accent-btn" disabled="[[preview]]" on-tap="_submitLabels" raised>submit</paper-button></div>
			</div>
		</div>

		
		
	</template>
	<script>
		Polymer({
			is: 'label-page',

			behaviors: [
				Polymer.NeonAnimationRunnerBehavior
			],

			properties: {
				uid: String,
				prj: String,
				tokens: {
					type: Array,
					observer: '_initData'
				},
				tokensPerPage: Number,
				labels: Array,
				selectedPage: {
					type: Number,
					value: 0
				},
				labelData: Array,
				splitTokens: Array,
				multiSelect: {
					type: Boolean,
					value: false
				},
				preview: Boolean,
				animationConfig: {
					type: Object,
					value: function() {
						return {
							next: [{
								name: 'slide-from-right-animation',
								timing: {delay: 200}
							}, {
								name: 'fade-out-animation',
								timing: {duration: 300}
							}],
							previous: [{
								name: 'slide-from-left-animation',
								timing: {delay: 200}
							}, {
								name: 'fade-out-animation',
								timing: {duration: 300}
							}]
						};
					}
				}
			},

			observers: [
				'computeSplitTokens(tokens,tokensPerPage)'
			],

			listeners: {
				'neon-animation-finish': '_onNeonAnimationFinish'
			},

			_onNeonAnimationFinish: function(e, animation) {
				// switch (animation) {
				// 	case 'next': 
				// 		break;
				// }
			},

			_initData: function(tk) {
				this.labelData =  tk.map(function(d) {
					return {};
				});
			},

			_computeListIndex: function(page, list) {
				return page * this.tokensPerPage + list;
			},

			_displaySave: function(tokens, page) {
				if (page !== tokens.length - 1) return true;
				return false;
			},

			_checkLabelData: function() {
				var data = this.labelData;
				var check = true;

				for (var i = 0; i < data.length; i++) {
					if (!data[i].labels || data[i].labels.length === 0) check = false;
				}
				return check;
			},

			_submitLabels: function() {
				for (var i = 0; i < this.tokens.length; i++) {
					var labels = this.multiSelect ? this.$$('.list_' + i).selectedValues : this.$$('.list_' + i).selected;
					this.labelData[i] = {
						docID: i,
						labels: labels
					};
				}

				if (!this._checkLabelData()) return;
				this.$.label.submitData(this.labelData);
				this.fire('route-page', 'thankyou', {bubbles: true});
			},

			computeSplitTokens: function(tokens, chunk) {
				chunk = parseInt(chunk);
				this.splitTokens = [];
				var temparray = [];

				for (var i = 0; i < tokens.length; i += chunk) {
			    temparray.push(tokens.slice(i, i + chunk));
				}
				this.splitTokens = temparray;
			},

			_computeTokens: function(tokens, page) {
				return tokens[page];
			},

			_disableNav: function(tokens, page, direction) {
				if (direction === 'next' && page === tokens.length - 1)
					return true;
				if (direction === 'prev' && page === 0)
					return true;
				return false;
			},

			prevPage: function() {
				this.animationConfig.previous[0].node = this.$$('.content_' + (this.selectedPage - 1));
				this.animationConfig.previous[1].node = this.$$('.content_' + this.selectedPage );
				this.playAnimation('previous');
				this.async(function() {
					this.selectedPage = this.selectedPage - 1;
				}, 300);
			},

			nextPage: function() {
				this.animationConfig.next[0].node = this.$$('.content_' + (this.selectedPage + 1));
				this.animationConfig.next[1].node = this.$$('.content_' + this.selectedPage );
				this.playAnimation('next');
				this.async(function() {
					this.selectedPage = this.selectedPage + 1;
				}, 300);

				var progress = this.selectedPage * 20;
				this.fire('progress-bar', progress, {bubbles: true});
			}
		});
	</script>
</dom-module>