<link rel="import" href="bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/app-layout/app-layout.html">
<link rel="import" href="src/theme/shared-styles.html">
<link rel="import" href="src/api/api-signin.html">
<link rel="import" href="src/api/api-config.html">
<link rel="import" href="src/instructions-page.html">
<link rel="import" href="src/admin-config.html">
<link rel="import" href="src/label-page.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">

<dom-module id="app-page">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      app-toolbar {
        background-color: var(--paper-teal-500);
      }
      app-header {
        /*@apply(--layout-fixed-top);*/
        color: white;
        --app-header-background-rear-layer: {
          background-color: #ef6c00;
        };
      }
      paper-menu {
        padding-top: 0px;
      }
      paper-item.settingsHeader {
        background-color: var(--paper-teal-800);
        color: white;
        padding-top: 8px;
      }
      paper-menu#settingsMenu {
        position: fixed;
        top: 64px;
        right: 0px;
      }
      #settingsMenu paper-item:not(:first-child) {
        cursor: pointer;
      }
      #analysisDropdown iron-dropdown.paper-menu-button {
        color: red;
      }
      paper-menu-button {
       --paper-menu-button-dropdown:{
          width:200px;
          top:64px !important;
          right: 0px;
          left: initial !important;
        };
      }
      .page-wrapper {
        padding: 3em;
      }
      paper-progress {
        display: block;
        width: 100%;
        --paper-progress-active-color: var(--paper-teal-a400);
        --paper-progress-container-color: rgba(255, 255, 255, 0.5);
        --paper-progress-transition-duration: 0.5s;
      }
      neon-animated-pages {
        min-height: calc(100vh - 64px);
      }
      paper-icon-button.settings {
        transition: transform 0.5s;
      }
      paper-icon-button.settings:hover {
        transform: rotate(90deg);
      }
      div.right-arrow {
        transition: all 0.5s;
        font-size: 11px;
      }
      paper-icon-button.settings:hover + div.right-arrow::after { content:'\25B6'; }
      #toastpreview { padding: 10px 25px; }
      .yellow-button {
        text-transform: none;
        color: #eeff41;
      }
    </style>

    <api-signin 
      id="login"
      uid="{{uid}}" 
      default-project="{{defaultProject}}"
      user="{{user}}"
      admin-user="{{adminUser}}">
    </api-signin>

    <app-header id="header" reveals>
      <app-toolbar>
        <div main-title>LabelSense</div>
        <paper-icon-button icon="settings" class="settings dropdown-trigger" on-tap="openMenu">
        </paper-icon-button>
        <div class="right-arrow"></div>
        <paper-progress class="transiting" value="[[progress]]" bottom-item></paper-progress>
      </app-toolbar>
    </app-header>

    <paper-toast id="toastpreview" class="fit-bottom" duration="0" text="This is a preview!">
      <paper-button on-tap="exitPreview" class="yellow-button">Close now!</paper-button>
    </paper-toast>

    <api-config id="config" config="{{config}}"></api-config>

    <div class="main-content">
      <neon-animated-pages id="page" selected="[[selectedPage]]" entry-animation="slide-from-right-animation" exit-animation="fade-out-animation">
        <admin-config class="page-wrapper" uid="[[uid]]" 
        default-project="[[defaultProject]]"></admin-config>
        <instructions-page id="instructions" class="page-wrapper" instructions="[[config.settings.instructions]]" on-log-out="logout"></instructions-page>
        <label-page class="page-wrapper" preview="[[preview]]" uid="[[uid]]" prj="[[config.prj]]" tokens="[[config.tokens]]" tokens-per-page="[[config.settings.display]]" labels="[[config.labels]]" multi-select="[[config.settings.multiLabel]]"></label-page>
      </neon-animated-pages>
<!--       <iron-pages id="page" selected="[[selectedPage]]">
        <admin-config class="page-wrapper" uid="[[uid]]" 
        default-project="[[defaultProject]]"></admin-config>
        <instructions-page id="instructions" class="page-wrapper" instructions="[[config.settings.instructions]]"></instructions-page>
        <label-page class="page-wrapper" uid="[[uid]]" prj="[[config.prj]]" tokens="[[config.tokens]]" tokens-per-page="5" labels="[[config.labels]]"></label-page>
      </iron-pages> -->
    </div>

    <paper-menu hidden$="[[showMenu]]" id="settingsMenu" class="shadow-2dp">
      <paper-item class="settingsHeader">Hello [[user.displayName]]!</paper-item>
      <paper-item hidden$="[[!adminUser]]" on-tap="routeToSettings">App Settings</paper-item>
      <paper-item hidden$="[[!user]]" on-tap="logout">Logout</paper-item>
    </paper-menu>
    
  </template>
  <script>
    Polymer({
      is: 'app-page',
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        HiveOSS.RouteBehavior
      ],
      properties: {
        eventHandler: Object,
        preview: Boolean,
        showMenu: {
          type: Boolean,
          value: true
        },
        selectedPage: Number,
        progress: {
          type: Number,
          value: 0
        },
        adminUser: {
          type: Boolean,
          observer: '_isAdmin',
          value: false
        },
        uid: {
          type: String,
          observer: 'getAdminDetails'
        },
        defaultProject: String,
        sharedElements: {
          value: function() {
            return {
              'hero': this.$.header
            }
          }
        },
        animationConfig: {
          value: function() {
            return {
              'entry': {
                name: 'hero-animation',
                id: 'hero',
                toPage: this
              },
              'entryMenu': {
                name: 'slide-from-right-animation',
                node: this.$.settingsMenu
              },
              'exitMenu': {
                name: 'slide-right-animation',
                node: this.$.settingsMenu
              }
            };
          }
        },
        spec: {
          type: Object,
          value: function() {
            return {
              title: 'Thank you!',
              buttonContent: 'finish'
            };
          }
        }
      },

      listeners: {
        'route-page': 'routePage',
        'progress-bar': '_progressBar',
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      _onNeonAnimationFinish: function(e, animation) {
        switch (animation) {
          case 'entryMenu': 
            window.addEventListener('click', this.eventHandler);
            break;
          case 'exitMenu':
            this.showMenu = true;
            window.removeEventListener('click', this.eventHandler);
            break;
        }
      },

      attached: function() {
        var listener = function(e) {
          var that = this.$.settingsMenu;
          var target = e.target;

          while (target != that && target != document.body) {
            target = Polymer.dom(target).node.parentElement;
          }

          if (target !== that) {
            if (!that.hidden) this.playAnimation('exitMenu', 'exitMenu');
          }
        };
        this.eventHandler =  listener.bind(this);
      },

      openMenu: function() {
        this.showMenu = false;
        this.playAnimation('entryMenu', 'entryMenu');
      },

      exitPreview: function() {
        this.preview = false;
        this.$.toastpreview.close();
        this.selectedPage = 0;
      },

      getAdminDetails: function() {
        this.$.login.getUser();
      },

      _isAdmin: function(admin) {
        if (!admin) {
          this.$.config.generateRequest();
          this.selectedPage = 1;
          return;
        }
        this.selectedPage = 0;
      },

      _progressBar: function(e, value) {
        this.progress = value;
      },

      routeToSettings: function() {
        this.selectedPage = 0;
      },

      routePage: function(e, page) {
        switch (page) {
          case 'label':
            this.selectedPage = 2;
            break;
          case 'thankyou':
            this.$.instructions.spec = this.spec;
            this.selectedPage = 1;
            break;
          case 'intro': 
            this.preview = true;
            this.$.config.generateRequest();
            this.$.toastpreview.open();
            this.selectedPage = 1;
            break;
        }
      },

      logout: function() {
        this.$.login.signOut();
      }
    });
  </script>
</dom-module>